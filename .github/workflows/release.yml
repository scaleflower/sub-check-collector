name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Install pkg globally
        run: npm install -g pkg pkg-fetch

      - name: Pre-fetch pkg binaries
        env:
          PKG_CACHE_PATH: ~/.pkg-cache
        run: |
          mkdir -p ~/.pkg-cache/v3.5
          # Pre-fetch binaries with retry mechanism
          for target in node18-linux-x64 node18-macos-x64 node18-win-x64; do
            echo "Fetching $target..."
            for i in 1 2 3 4 5; do
              npx pkg-fetch $target && break || echo "Attempt $i failed, retrying..."
              sleep 10
            done
          done

      - name: Package for all platforms
        env:
          PKG_CACHE_PATH: ~/.pkg-cache
        run: |
          mkdir -p dist/bin
          pkg dist/index.js \
            --targets node18-win-x64,node18-macos-x64,node18-linux-x64 \
            --out-path dist/bin \
            --compress GZip

      - name: List built files
        run: ls -la dist/bin/

      - name: Prepare release packages
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Create release directories
          mkdir -p release/sub-check-collector-${VERSION}-windows
          mkdir -p release/sub-check-collector-${VERSION}-macos
          mkdir -p release/sub-check-collector-${VERSION}-linux
          
          # Copy common files
          for platform in windows macos linux; do
            cp config.yaml.example release/sub-check-collector-${VERSION}-${platform}/
            cp .env.example release/sub-check-collector-${VERSION}-${platform}/
            cp README.md release/sub-check-collector-${VERSION}-${platform}/
            cp QUICKSTART.md release/sub-check-collector-${VERSION}-${platform}/
          done
          
          # Copy platform-specific executables and scripts
          cp dist/bin/index-win.exe release/sub-check-collector-${VERSION}-windows/sub-check-collector.exe
          cp start.bat release/sub-check-collector-${VERSION}-windows/
          cp run.bat release/sub-check-collector-${VERSION}-windows/
          
          cp dist/bin/index-macos release/sub-check-collector-${VERSION}-macos/sub-check-collector
          cp start.sh release/sub-check-collector-${VERSION}-macos/
          chmod +x release/sub-check-collector-${VERSION}-macos/sub-check-collector
          chmod +x release/sub-check-collector-${VERSION}-macos/start.sh
          
          cp dist/bin/index-linux release/sub-check-collector-${VERSION}-linux/sub-check-collector
          cp start.sh release/sub-check-collector-${VERSION}-linux/
          chmod +x release/sub-check-collector-${VERSION}-linux/sub-check-collector
          chmod +x release/sub-check-collector-${VERSION}-linux/start.sh
          
          # Create zip archives
          cd release
          zip -r sub-check-collector-${VERSION}-windows.zip sub-check-collector-${VERSION}-windows/
          tar -czvf sub-check-collector-${VERSION}-macos.tar.gz sub-check-collector-${VERSION}-macos/
          tar -czvf sub-check-collector-${VERSION}-linux.tar.gz sub-check-collector-${VERSION}-linux/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.zip
            release/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
